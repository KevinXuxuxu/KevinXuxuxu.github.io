<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Fangzhou Xu,kevin.xu.fangzhou@gmail.com"><title>A Peek into System Security · Kevin Xu</title><meta name="description" content="This morning I got reached out by 2 tech companies: GitGuardian and Slack, about a same issue related to the repository I just created: prometheus-ecs"><meta name="keywords" content="Python,Coding"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:150px;"><h3 title=""><a href="/">Kevin Xu</a></h3><div class="description"><p>Entry level coder in sillicon valley, Otaku.</p></div></div></div><ul class="social-links"><li><a href="https://twitter.com/OrikiXu"><i class="fa fa-twitter"></i></a></li><li><a href="http://weibo.com/1970882853"><i class="fa fa-weibo"></i></a></li><li><a href="http://facebook.com/kevin.xu.1272010"><i class="fa fa-facebook"></i></a></li><li><a href="http://github.com/KevinXuxuxu"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/category">分类/标签</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img src="/images/logo.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>A Peek into System Security</a></h3></div><div class="post-content"><p>This morning I got reached out by 2 tech companies: <a href="https://www.gitguardian.com/" target="_blank" rel="external">GitGuardian</a> and Slack, about a same issue related to the repository I just created: <a href="https://github.com/KevinXuxuxu/prometheus-ecs" target="_blank" rel="external">prometheus-ecs</a>, which is a flattering experience. Sorry, it’s not that my repo is so good that they want to initiate business collaboration or anything, it’s just that they found out one of my Slack webhook url is exposed in my (apparently public) repository, and were kind enough to warn me of it. Slack even went as far as directly revoking the exposed URL and issuing a new one.</p>
<p>I know it sounds like a stupid mistake that any engineer with some minimum industry experience and proper practice training shouldn’t make. But here’s some context: Recently I have been working on a side project about system monitoring and alerting. As I build, setup and operate a bunch of web services (for myself and my gf), I would like to be aware of their availability, even being alerted when things go down. As a natural result, I choose to use the famous open source project <a href="https://prometheus.io" target="_blank" rel="external">Prometheus</a>, and would like to explore <a href="https://aws.amazon.com/cn/ecs/" target="_blank" rel="external">AWS Elastic Container Service</a> for deployment (if which works out, will be a cheaper choice for hosting any of my service).</p>
<p>After some intense (and a little frustrating) learning, I figured out that I need 3 components to achieve what I wanted:</p>
<ul>
<li>Prometheus main service (of course)</li>
<li>Blackbox exporter (for blackbox monitoring, as I’m tight on resources and don’t want to run any side car services or do any extensive coding on my existing services)</li>
<li>Alert manager (for sending out alert via email or Slack)</li>
</ul>
<p>Luckily folks from Prometheus have everything covered by supporting each of them as a docker image for swift deployment. Just mount some custom config and run them on ECS should do the work, peice of cake. That’s what I thought before I realised that ECS doesn’t actually support any volume mount. Yes, there’s no way for you to dynamically pass files into containers with ECS, you’ll have to build the file into the docker image. I think this is how AWS is enforcing the security <a href="https://digitalguardian.com/blog/what-principle-least-privilege-polp-best-practice-information-security-and-compliance" target="_blank" rel="external">Principal of Least Privilege</a>, since you can always build every file/logic you need into the image.</p>
<p>So I started writing Dockerfiles, which should be as easy as <code>FROM prom/prometheus</code> plus <code>COPY prometheus.yml /etc/prometheus</code>, where it overwrites the config file with my custom one (and same for the alert manager, and blackbox exporter is stateless). Since I already have custom config and Dockerfiles, I might as well create a Github repo for it.</p>
<p>The problem was with the config for the alert manager (I skipped the failure of trying to make Gmail SMTP server work, so anyways I ended up with slack for notification). For some <a href="https://github.com/prometheus/alertmanager/issues/2207" target="_blank" rel="external">not-so-obvious reason</a>, Prometheus decides not to support templating for <code>slack_api_url</code>, aka. it will not automatically render env variables into config file (which is actually <a href="https://12factor.net/config" target="_blank" rel="external">a standard practice</a> for micro services to get config or credentials). After a long day of struggling with all the tech details, I took the liberty to hard-code my Slack webhook url into the config file, and got busted by 2 companies (I’m suspecting that Slack actually hired GitGuardian but whatever).</p>
<p>To my defense, I do know the correct way to solve this thing, which is to write a custom templating logic into dockerfile (which is a good opportunity to pick up some shell magic):<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ENTRYPOINT sed -i <span class="string">"s=WEBHOOK_URL=<span class="variable">$&#123;WEBHOOK_URL&#125;</span>=g"</span> /etc/alertmanager/alertmanager.yml &amp;&amp; \</div><div class="line">    /bin/alertmanager --config.file=/etc/alertmanager/alertmanager.yml --storage.path=/alertmanager</div></pre></td></tr></table></figure></p>
<p>I think the takeaway here is that don’t ever be lazy over security issues, or it’s definitely going to be discovered. I’m just lucky to be discovered by some good(?) folks.</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2021-09-22</span><i class="fa fa-comment-o"></i><a href="/2021/09/22/a-peek-into-system-security/#comments">评论</a><i class="fa fa-tag"></i><a href="/categories/tech/" title="tech" class="tag">tech </a><a href="/tags/index/" title="index" class="tag">index </a><a href="/tags/AWS/" title="AWS" class="tag">AWS </a><a href="/tags/infra/" title="infra" class="tag">infra </a><a href="/tags/Monitoring/" title="Monitoring" class="tag">Monitoring </a><a href="/tags/Security/" title="Security" class="tag">Security </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,http://fzxu.me/2021/09/22/a-peek-into-system-security/,Kevin Xu,A Peek into System Security,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a role="navigation" href="/2021/01/03/AoC-2020(2)/" title="AoC 2020 (2)" class="btn">下一篇</a></li></ul></div><a id="comments"></a><div id="disqus_thread"></div><script>var disqus_shortname = 'kevinxu-1';
var disqus_identifier = '2021/09/22/a-peek-into-system-security/';
var disqus_title = 'A Peek into System Security';
var disqus_url = 'http://fzxu.me/2021/09/22/a-peek-into-system-security/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//kevinxu-1.disqus.com/count.js" async></script></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>