<!DOCTYPE html>
<html lang="en">
    <head>
        <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
        <link rel="stylesheet" href="/static/pygments_style.css">
    </head>
    <body>
        <div class="main container grid-lg">
            <header>
                <nav>
                    <ul class="breadcrumb">
                        <li class="breadcrumb-item">&nbsp;
                    </ul>
                </nav>
                
                    <a href="/">back</a>
                
                <h1 class="heading-index">AWS + Shadowsocks翻墙DIY</h1>

                <p class="text-gray"><small>
                    2015-09-14 09:43:23
                </small></p>
            </header>
                
            <main class="content columns">
                <div class="column col-sm-12 col-md-10 col-8">
                    
                    <ul>
<li>前两天终于从加州回来，除了和家人进行了感动人心的重逢以及吃啥都觉得好吃的体验，还愈发的感觉到国内网络环境的糟糕。在家连 Gmail 都上不去，已然到了不能忍受的程度。于是昨天在摸哥的帮助下在 AWS 上搭了一个 Shadowsocks 服务器，本地用 Shadowsocks 的命令行工具就可以实现科学上网。虽然有一些比较 tricky 的地方需要注意，但还是成功搞定，和室友们愉快的欣赏了“怒斥香港记者”、“二院讲话”、“人民代表大会答记者问”等经典片段。</li>
</ul>
<h4>申请和启动 AWS 虚拟机</h4>
<ul>
<li><p>首先到 AWS 主页 <a href="aws.amazon.com/cn/">aws.amazon.com/cn/</a>， 点击注册，新用户登陆，填写信息，付款信息（除了银联的借记卡以外其他好像都可以，反正免费使用一年^q^），电话，然后是身份验证（只要把电脑上的四位数用手机键盘输入就好了），支持方案选择基本就好，然后就可以确认并登陆控制台。</p>
</li>
<li><p>可以发现 AWS 实际上提供了相当全面而强大的各种网络服务。我们只需要最基本的EC2就可以了。</p>
</li>
<li><p>这时可以发现服务需要24小时才能完全激活，所以可以等着了 ^q^</p>
</li>
<li><p>为了达到最好的网络速度，最好在控制面板的右上角将地区改变为“亚太地区（东京）”</p>
</li>
<li><p>第二天再回来，点击 EC2 可以进入 EC2控制面板。然后点击“启动实例”</p>
<ul>
<li>选择 Amazon 系统映像（AMI）：我们就用一个 <code>Ubuntu Server 14.04 LTS (HVM)</code> 就好了。</li>
<li>实例类型：如果是自己用的话，选择 <code>t2.nano</code> 就够用了。不过如果是刚刚注册的账号可以用 <code>t2.micro</code>，可以免费用一年。</li>
<li>核查实例并启动：直接点击启动，随后会弹出要选择密钥对的框，点击创建新的密钥对，名字随便起（比如 <code>foo</code>），然后下载密钥对，会得到名为 <code>foo.pem</code> 的文件，这时进入命令行，修改权限：</li>
</ul>
<div class="highlight">
    <pre class="code" data-lang="Bash"><span></span><code>$ sudo chmod <span class="m">400</span> foo.pem
</code></pre>
</div><p>然后就可以启动实例啦。</p>
<ul>
<li>您的实例正在启动：点击查看实例，等到实例状态变成 running 之后，记录下公有IP（比如 <code>1.2.3.4</code>）</li>
<li>从命令行登陆：用密钥对和公有IP登陆实例</li>
</ul>
<div class="highlight">
    <pre class="code" data-lang="Bash"><span></span><code>$ ssh -i foo.pem ubuntu@1.2.3.4
Welcome to Ubuntu <span class="m">14</span>.04.2 LTS <span class="o">(</span>GNU/Linux <span class="m">3</span>.13.0-48-generic x86_64<span class="o">)</span>

 * Documentation:  https://help.ubuntu.com/

  System information as of Sun Sep <span class="m">13</span> <span class="m">15</span>:36:41 UTC <span class="m">2015</span>

  System load:  <span class="m">0</span>.0               Processes:           <span class="m">100</span>
  Usage of /:   <span class="m">12</span>.3% of <span class="m">7</span>.74GB   Users logged <span class="k">in</span>:     <span class="m">0</span>
  Memory usage: <span class="m">9</span>%                IP address <span class="k">for</span> eth0: <span class="m">172</span>.31.19.130
  Swap usage:   <span class="m">0</span>%

  Graph this data and manage this system at:
    https://landscape.canonical.com/

  Get cloud support with Ubuntu Advantage Cloud Guest:
    http://www.ubuntu.com/business/services/cloud

Last login: Sun Sep <span class="m">13</span> <span class="m">15</span>:36:42 <span class="m">2015</span> from <span class="m">4</span>.3.2.1
ubuntu@ip-172-31-19-130:~$
</code></pre>
</div><p>这样就登陆成功啦</p>
</li>
</ul>
<h4>设置 Shadowsocks Server 端</h4>
<ul>
<li>安装 <code>pip</code></li>
</ul>
<div class="highlight">
    <pre class="code" data-lang="Bash"><span></span><code>$ sudo apt-get update
$ sudo apt-get install python-pip
</code></pre>
</div><ul>
<li>安装 Shadowsocks</li>
</ul>
<div class="highlight">
    <pre class="code" data-lang="Bash"><span></span><code>$ sudo pip install shadowsocks
</code></pre>
</div><ul>
<li>启动 shadowsocks server</li>
</ul>
<div class="highlight">
    <pre class="code" data-lang="Bash"><span></span><code>$ sudo ssserver -p <span class="m">443</span> -k password -m aes-256-cfb
</code></pre>
</div><pre><code>- 其中 `-p` 指定了服务器的端口
- `-k` 指定了服务器的登陆密码
- `-m` 指定了 `method` 即加密方法

</code></pre><ul>
<li><p>这里为了让它在后台启动，可以使用 Ubuntu 自带的后台bash管理工具 <code>screen</code></p>
<ul>
<li>运行 <code>screen</code>，然后回车，就进入了一个新的bash，在这里我们可以启动 <code>ssserver</code>。</li>
<li>用 ctrl+A ctrl+D 可以 detach 这个 bash。</li>
<li>用下面命令可以查看有哪些后台的 bash 在运行</li>
</ul>
<div class="highlight">
    <pre class="code" data-lang="Bash"><span></span><code>$ screen -list
There is a screen on:
	<span class="m">7160</span>.pts-3.ip-172-31-19-130	<span class="o">(</span><span class="m">09</span>/13/15 <span class="m">13</span>:50:07<span class="o">)</span>	<span class="o">(</span>Detached<span class="o">)</span>
<span class="m">1</span> Socket <span class="k">in</span> /var/run/screen/S-ubuntu.
</code></pre>
</div><ul>
<li>用下面命令可以重新进入（atach）后台bash</li>
</ul>
<div class="highlight">
    <pre class="code" data-lang="Bash"><span></span><code>$ screen -R pts-3.ip-172-31-19-130
</code></pre>
</div></li>
<li><p>AWS 默认只允许 22 端口的外网访问（即只能 ssh 连接），我们需要给安全组添加规则以允许来自 443 端口的访问。</p>
<ul>
<li>在查看实例中找到你的实例，点击最右面的安全组</li>
<li>在下面点击入站，编辑</li>
<li>在弹出框中点击添加规则，自定义tcp规则，端口范围为 443，保存。</li>
</ul>
</li>
<li><p>事实上 <code>ssserver</code> 自己也支持后台启动。只要在自后添加上 <code>-d start</code> 的参数，就可以在后台启动相同的服务器程序。运行的 log 被储存在 <code>/var/log/shadowsocks.log</code> 中，可用如下命令随时查看。</p>
<div class="highlight">
    <pre class="code" data-lang="Bash"><span></span><code>$ tail -f /var/log/shadowsocks.log
</code></pre>
</div></li>
<li><p><code>ssserver</code> 也可以用配置文件来启动，这样可以保证 server 和 client 的配置统一：</p>
<div class="highlight">
    <pre class="code" data-lang="Bash"><span></span><code>$ sudo ssserver -c shadowsocks-libev.json
</code></pre>
</div><p>注意其中的 <code>server</code> 配置最好填写 <code>0.0.0.0</code>.</p>
</li>
</ul>
<h4>Mac 上的 Shadowsocks 客户端（命令行工具）</h4>
<ul>
<li>安装 Homebrew：见 <a href="http://brew.sh/">brew.sh</a></li>
<li>更新列表</li>
</ul>
<div class="highlight">
    <pre class="code" data-lang="Bash"><span></span><code>$ brew update
</code></pre>
</div><ul>
<li>安装 shadowsocks-libev</li>
</ul>
<div class="highlight">
    <pre class="code" data-lang="Bash"><span></span><code>$ brew install shadowsocks-libev
</code></pre>
</div><ul>
<li>修改客户端的配置文件 <code>/usr/local/etc/shadowsocks-libev.json</code>，使其能够连接到相应的 Shadowsocks server：</li>
</ul>
<div class="highlight">
    <pre class="code" data-lang="JSON"><span></span><code><span class="p">{</span>
    <span class="nt">&quot;server&quot;</span><span class="p">:</span><span class="s2">&quot;1.2.3.4&quot;</span><span class="p">,</span>
    <span class="nt">&quot;server_port&quot;</span><span class="p">:</span><span class="mi">443</span><span class="p">,</span>
    <span class="nt">&quot;local_port&quot;</span><span class="p">:</span><span class="mi">1080</span><span class="p">,</span>
    <span class="nt">&quot;password&quot;</span><span class="p">:</span><span class="s2">&quot;password&quot;</span><span class="p">,</span>
    <span class="nt">&quot;timeout&quot;</span><span class="p">:</span><span class="mi">600</span><span class="p">,</span>
    <span class="nt">&quot;method&quot;</span><span class="p">:</span><span class="s2">&quot;aes-256-cfb&quot;</span>
<span class="p">}</span>
</code></pre>
</div><ul>
<li>根据安装后的信息，可以有以下几种方式<ul>
<li>将客户端以服务的形式添加进启动项里：</li>
</ul>
<div class="highlight">
    <pre class="code" data-lang="Bash"><span></span><code>$ ln -sfv /usr/local/opt/shadowsocks-libev/*.plist ~/Library/LaunchAgents
</code></pre>
</div><ul>
<li>单次启动服务</li>
</ul>
<div class="highlight">
    <pre class="code" data-lang="Bash"><span></span><code>$ launchctl load ~/Library/LaunchAgents/homebrew.mxcl.shadowsocks-libev.plist
</code></pre>
</div><ul>
<li>直接启动客户端</li>
</ul>
<div class="highlight">
    <pre class="code" data-lang="Bash"><span></span><code>$ /usr/local/opt/shadowsocks-libev/bin/ss-local -c /usr/local/etc/shadowsocks-libev.json
</code></pre>
</div></li>
<li>启动之后，进入 系统设置 -&gt; 网络 -&gt; 高级 -&gt; 代理（Proxies），勾选 SOCKS代理，在代理服务器里填上 <code>127.0.0.1:1080</code>。如果有什么不想用代理访问的域名，比如 <code>localhost</code>、校园网什么的，可以添加在最下面的框里（支持正则表达）。</li>
<li>打开浏览器，在地址栏中输入 <code>youtube.com</code>，在搜索框中输入 “怒斥” 并搜索。</li>
</ul>
<h4>Trouble Shooting</h4>
<ul>
<li>在安装和启动 <code>ssserver</code> 的时候，可能会出现这样的问题：</li>
</ul>
<pre><code>AttributeError: /usr/lib/x86_64-Linux-gnu/libcrypto.so.1.1: undefined symbol: EVP_CIPHER_CTX_cleanup
</code></pre><pre><code>- 这个问题是由于在openssl1.1.0版本中，废弃了EVP_CIPHER_CTX_cleanup函数。我们可以用以下命令找到 `openssl.py` 的源文件，然后将其中的 `EVP_CIPHER_CTX_cleanup` 修改为新的命名 `EVP_CIPHER_CTX_reset` 即可。
``` Bash
$ find / -name openssl.py
```
- [Reference](https://blog.csdn.net/blackfrog_unique/article/details/60320737)
</code></pre>
                    
                </div>
            </main>
        </div>
    </body>
</html>